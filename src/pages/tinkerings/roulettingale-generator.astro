---
import BaseHead from "../../components/BaseHead.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

const title = "Roulettingale Generator";
const description = "Simulate the Martingale betting system on roulette and track results over time";

const casinos = [
  { name: "MGM", minBet: 25, maxBet: 10000 },
  { name: "Beau Rivage", minBet: 10, maxBet: 10000 },
  { name: "Mirage", minBet: 25, maxBet: 20000 },
];

const betTypes = [
  { value: "red", label: "Red" },
  { value: "black", label: "Black" },
  { value: "even", label: "Even" },
  { value: "odd", label: "Odd" },
  { value: "1-18", label: "1-18" },
  { value: "19-36", label: "19-36" },
  { value: "random", label: "Random" },
];

// Roulette wheel data (American roulette with 0 and 00)
const wheelNumbers = [
  { number: 0, color: "green" },
  { number: "00", color: "green" },
  { number: 1, color: "red" },
  { number: 2, color: "black" },
  { number: 3, color: "red" },
  { number: 4, color: "black" },
  { number: 5, color: "red" },
  { number: 6, color: "black" },
  { number: 7, color: "red" },
  { number: 8, color: "black" },
  { number: 9, color: "red" },
  { number: 10, color: "black" },
  { number: 11, color: "black" },
  { number: 12, color: "red" },
  { number: 13, color: "black" },
  { number: 14, color: "red" },
  { number: 15, color: "black" },
  { number: 16, color: "red" },
  { number: 17, color: "black" },
  { number: 18, color: "red" },
  { number: 19, color: "red" },
  { number: 20, color: "black" },
  { number: 21, color: "red" },
  { number: 22, color: "black" },
  { number: 23, color: "red" },
  { number: 24, color: "black" },
  { number: 25, color: "red" },
  { number: 26, color: "black" },
  { number: 27, color: "red" },
  { number: 28, color: "black" },
  { number: 29, color: "black" },
  { number: 30, color: "red" },
  { number: 31, color: "black" },
  { number: 32, color: "red" },
  { number: 33, color: "black" },
  { number: 34, color: "red" },
  { number: 35, color: "black" },
  { number: 36, color: "red" },
];
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap');

      body {
        background: #ecf1ec;
        font-family: 'Lora', Georgia, serif;
        font-weight: 400;
        color: #535353;
      }

      h1, h2, h3, h4, h5 {
        color: #7a6952;
        font-family: 'Lora', Georgia, serif;
        font-weight: 500;
      }

      .card {
        background: #f7f9f7;
        border: 1px solid #d7d2cb;
        border-radius: 3px;
        padding: 1.5rem;
      }

      .wheel {
        display: block;
        margin: 1rem auto;
        width: 180px;
      }

      /* Form inputs */
      .form-select, .form-input {
        background: #fff;
        border: 1px solid #d7d2cb;
        border-radius: 3px;
        color: #535353;
        font-family: 'Lora', Georgia, serif;
        padding: 0.5rem 0.75rem;
        width: 100%;
      }

      .form-select:focus, .form-input:focus {
        outline: none;
        border-color: #7a6952;
        box-shadow: 0 0 0 2px rgba(122, 105, 82, 0.2);
      }

      .form-label {
        color: #7a6952;
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
      }

      /* Buttons */
      .btn {
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-family: 'Lora', Georgia, serif;
        font-weight: 500;
        padding: 0.625rem 1.25rem;
        transition: all 0.15s ease;
      }

      .btn-primary {
        background: #7a6952;
        color: #fff;
      }

      .btn-primary:hover {
        background: #5d4f3d;
      }

      .btn-primary:disabled {
        background: #bfbfbf;
        cursor: not-allowed;
      }

      .btn-success {
        background: #799985;
        color: #fff;
      }

      .btn-success:hover {
        background: #588067;
      }

      /* Stats */
      .stat-value {
        font-size: 2rem;
        font-weight: 600;
        line-height: 1;
      }

      .stat-label {
        color: #7e7e7e;
        font-size: 0.75rem;
      }

      .positive { color: #728271; }
      .negative { color: #c55842; }

      /* Number badges */
      .number-badge {
        border-radius: 50%;
        display: inline-block;
        font-size: 0.75rem;
        font-weight: 600;
        height: 2rem;
        line-height: 2rem;
        text-align: center;
        width: 2rem;
      }

      .number-green { background: #588067; color: #fff; }
      .number-red { background: #c55842; color: #fff; }
      .number-black { background: #1f2937; color: #fff; }

      /* Win/Loss badges */
      .result-badge {
        border-radius: 10px;
        display: inline-block;
        font-size: 0.6rem;
        height: 20px;
        line-height: 20px;
        text-align: center;
        width: 20px;
      }

      .result-win {
        background: #799985;
        border: 2px solid #588067;
        color: #ecf1ec;
      }

      .result-loss {
        background: #d07967;
        border: 2px solid #c55842;
        color: #ecf1ec;
      }

      /* Table */
      .spins-table {
        border-collapse: collapse;
        font-size: 0.875rem;
        width: 100%;
      }

      .spins-table th {
        background: #ede3ba;
        border: 1px solid #ecf1ec;
        color: #7a6952;
        font-weight: 500;
        padding: 0.5rem;
        text-align: center;
      }

      .spins-table td {
        border: 1px solid #ecf1ec;
        padding: 0.5rem;
        text-align: center;
      }

      .spins-table tbody tr:nth-child(even) td {
        background: #e2e9e2;
      }

      .spins-table tbody tr:nth-child(odd) td {
        background: #e6ece5;
      }

      /* Status badge */
      .status-badge {
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.25rem 0.75rem;
      }

      .status-running {
        background: #ede3ba;
        color: #7a6952;
      }

      .status-goal {
        background: #799985;
        color: #fff;
      }

      .status-busted {
        background: #c55842;
        color: #fff;
      }

      /* Animations */
      .spin-row {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .running {
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Layout helpers */
      .cell {
        margin: 0 auto;
        max-width: 900px;
        padding: 0 1rem;
      }

      .grid-2 {
        display: grid;
        gap: 1.5rem;
        grid-template-columns: 1fr;
      }

      @media (min-width: 640px) {
        .grid-2 {
          grid-template-columns: 1fr 1fr;
        }
      }

      .grid-3 {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(3, 1fr);
      }

      .text-center { text-align: center; }
      .mt-1 { margin-top: 1rem; }
      .mt-2 { margin-top: 2rem; }
      .mb-1 { margin-bottom: 1rem; }
      .mb-2 { margin-bottom: 2rem; }

      /* Dollars prefix */
      .dollars::before {
        content: "$";
        font-size: 75%;
        opacity: 0.6;
        vertical-align: top;
      }

      .note {
        color: #7e7e7e;
        font-size: 0.75rem;
        font-style: italic;
      }

      .hidden { display: none; }
      .opacity-50 { opacity: 0.5; }
    </style>
  </head>
  <body>
    <Header />
    <main class="cell mt-2 mb-2">
      <div class="text-center">
        <img class="wheel" src="/tinkerings/roulettingale/roulette-wheel.svg" alt="Roulette wheel" />
        <h1>{title}</h1>
        <p>
          Test the Martingale betting system. Double your bet after each loss until you hit your profit goal or bust.
        </p>
        <p class="note">Bet type is cosmetic — all 50/50 bets have identical odds (~47.4%)</p>
      </div>

      <!-- Setup Form -->
      <div id="setup-form" class="card mt-2">
        <h2 class="text-center">Session Setup</h2>

        <div class="grid-2 mt-1">
          <div>
            <label class="form-label">Casino</label>
            <select id="casino-select" class="form-select">
              {casinos.map((casino) => (
                <option value={JSON.stringify(casino)}>
                  {casino.name} (${casino.minBet} - ${casino.maxBet.toLocaleString()})
                </option>
              ))}
            </select>
          </div>

          <div>
            <label class="form-label">Profit Goal</label>
            <input
              type="number"
              id="profit-goal"
              value="100"
              min="1"
              class="form-input"
            />
          </div>

          <div>
            <label class="form-label">Bet Type</label>
            <select id="bet-type" class="form-select">
              {betTypes.map((bet) => (
                <option value={bet.value}>{bet.label}</option>
              ))}
            </select>
          </div>

          <div style="display: flex; align-items: flex-end;">
            <button id="run-session" class="btn btn-primary" style="width: 100%;">
              Run Session
            </button>
          </div>
        </div>
      </div>

      <!-- Session Progress -->
      <div id="session-progress" class="hidden">
        <div class="card mt-2">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">Session Progress</h2>
            <span id="session-status" class="status-badge status-running running">Running...</span>
          </div>

          <div class="grid-3 mt-1 text-center">
            <div>
              <div class="stat-value" id="current-profit">$0</div>
              <div class="stat-label">Current Profit</div>
            </div>
            <div>
              <div class="stat-value" id="current-bet">$0</div>
              <div class="stat-label">Next Bet</div>
            </div>
            <div>
              <div class="stat-value" id="spin-count">0</div>
              <div class="stat-label">Spins</div>
            </div>
          </div>

          <div class="mt-1" style="overflow-x: auto;">
            <table class="spins-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Bet</th>
                  <th>Amount</th>
                  <th>Number</th>
                  <th>Result</th>
                  <th>Profit</th>
                </tr>
              </thead>
              <tbody id="spins-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Final Result -->
      <div id="final-result" class="hidden card mt-2">
        <h2 class="text-center">Session Complete</h2>
        <p id="result-message" class="text-center" style="font-size: 1.125rem;"></p>
        <div class="text-center">
          <button id="new-session" class="btn btn-success">
            Run Another Session
          </button>
        </div>
      </div>
    </main>
    <Footer />

    <script define:vars={{ wheelNumbers }}>
      const wheel = wheelNumbers;

      function spin() {
        const index = Math.floor(Math.random() * wheel.length);
        return wheel[index];
      }

      function getBetTypeForSpin(selectedType) {
        if (selectedType === 'random') {
          const types = ['red', 'black', 'even', 'odd', '1-18', '19-36'];
          return types[Math.floor(Math.random() * types.length)];
        }
        return selectedType;
      }

      function checkWin(result, betType) {
        const num = result.number;

        // Green always loses for 50/50 bets
        if (result.color === 'green') return false;

        const numValue = typeof num === 'number' ? num : 0;

        switch (betType) {
          case 'red': return result.color === 'red';
          case 'black': return result.color === 'black';
          case 'even': return numValue % 2 === 0;
          case 'odd': return numValue % 2 === 1;
          case '1-18': return numValue >= 1 && numValue <= 18;
          case '19-36': return numValue >= 19 && numValue <= 36;
          default: return false;
        }
      }

      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      async function runSession() {
        const casinoSelect = document.getElementById('casino-select');
        const profitGoalInput = document.getElementById('profit-goal');
        const betTypeSelect = document.getElementById('bet-type');
        const runButton = document.getElementById('run-session');

        const casino = JSON.parse(casinoSelect.value);
        const profitGoal = parseInt(profitGoalInput.value, 10);
        const selectedBetType = betTypeSelect.value;
        const baseBet = casino.minBet;

        // Disable form
        runButton.disabled = true;

        // Show progress
        document.getElementById('setup-form').classList.add('opacity-50');
        document.getElementById('session-progress').classList.remove('hidden');
        document.getElementById('final-result').classList.add('hidden');

        // Reset display
        const spinsTable = document.getElementById('spins-table');
        spinsTable.innerHTML = '';

        let currentProfit = 0;
        let currentBet = baseBet;
        let spins = [];
        let spinNumber = 0;

        // Update initial display
        document.getElementById('current-profit').textContent = '$0';
        document.getElementById('current-profit').className = 'stat-value';
        document.getElementById('current-bet').textContent = `$${baseBet}`;
        document.getElementById('spin-count').textContent = '0';

        // Reset status
        const statusEl = document.getElementById('session-status');
        statusEl.className = 'status-badge status-running running';
        statusEl.textContent = 'Running...';

        // Run simulation
        while (currentProfit < profitGoal) {
          // Check if we can afford the bet
          if (currentBet > casino.maxBet) {
            break; // Busted - can't cover the bet
          }

          spinNumber++;
          const betType = getBetTypeForSpin(selectedBetType);
          const thisBet = currentBet; // Capture bet amount before result
          const result = spin();
          const won = checkWin(result, betType);

          if (won) {
            currentProfit += thisBet;
            currentBet = baseBet; // Reset to base bet
          } else {
            currentProfit -= thisBet;
            currentBet = thisBet * 2; // Double the bet for next spin
          }

          spins.push({
            bet: thisBet,
            betType,
            number: result.number,
            color: result.color,
            win: won,
            profit: currentProfit
          });

          // Update display
          updateDisplay({
            spinNumber,
            betType,
            betAmount: thisBet,
            number: result.number,
            color: result.color,
            won
          }, currentProfit, currentBet, spinNumber);

          // Wait for dramatic effect
          await sleep(1000);
        }

        // Determine outcome
        const outcome = currentProfit >= profitGoal ? 'goal' : 'busted';

        // Update status
        statusEl.classList.remove('running', 'status-running');
        if (outcome === 'goal') {
          statusEl.classList.add('status-goal');
          statusEl.textContent = 'Goal Reached!';
        } else {
          statusEl.classList.add('status-busted');
          statusEl.textContent = 'Busted!';
        }

        // Save session
        const sessionData = {
          casino,
          profitGoal,
          betType: selectedBetType,
          baseBet,
          spins,
          outcome,
          finalProfit: currentProfit,
          totalSpins: spinNumber
        };

        try {
          await fetch('/api/roulettingale-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(sessionData)
          });
        } catch (err) {
          console.error('Failed to save session:', err);
        }

        // Show final result
        const resultEl = document.getElementById('final-result');
        const messageEl = document.getElementById('result-message');
        resultEl.classList.remove('hidden');

        if (outcome === 'goal') {
          messageEl.innerHTML = `<span class="positive"><strong>Success!</strong></span> Hit the <span class="dollars">${profitGoal}</span> profit goal in <strong>${spinNumber}</strong> spins.`;
        } else {
          messageEl.innerHTML = `<span class="negative"><strong>Busted!</strong></span> Couldn't cover the next bet (<span class="dollars">${currentBet.toLocaleString()}</span>) after <strong>${spinNumber}</strong> spins.<br>Final profit: <span class="negative dollars">${currentProfit.toLocaleString()}</span>`;
        }

        // Re-enable form
        runButton.disabled = false;
        document.getElementById('setup-form').classList.remove('opacity-50');
      }

      function updateDisplay(spinData, currentProfit, nextBet, spinCount) {
        // Update stats
        const profitEl = document.getElementById('current-profit');
        profitEl.textContent = `$${currentProfit.toLocaleString()}`;
        profitEl.className = `stat-value ${currentProfit >= 0 ? 'positive' : 'negative'}`;

        document.getElementById('current-bet').textContent = `$${nextBet.toLocaleString()}`;
        document.getElementById('spin-count').textContent = spinCount;

        // Add row to table
        const spinsTable = document.getElementById('spins-table');
        const row = document.createElement('tr');
        row.className = 'spin-row';
        row.innerHTML = `
          <td>${spinData.spinNumber}</td>
          <td style="text-transform: capitalize;">${spinData.betType}</td>
          <td><span class="dollars">${spinData.betAmount.toLocaleString()}</span></td>
          <td>
            <span class="number-badge number-${spinData.color}">
              ${spinData.number}
            </span>
          </td>
          <td>
            <span class="result-badge ${spinData.won ? 'result-win' : 'result-loss'}">
              ${spinData.won ? '✓' : '✗'}
            </span>
          </td>
          <td class="${currentProfit >= 0 ? 'positive' : 'negative'}">
            <span class="dollars">${currentProfit.toLocaleString()}</span>
          </td>
        `;
        spinsTable.insertBefore(row, spinsTable.firstChild);
      }

      // Event listeners
      document.getElementById('run-session').addEventListener('click', runSession);
      document.getElementById('new-session').addEventListener('click', () => {
        document.getElementById('session-progress').classList.add('hidden');
        document.getElementById('final-result').classList.add('hidden');
        runSession();
      });
    </script>
  </body>
</html>
