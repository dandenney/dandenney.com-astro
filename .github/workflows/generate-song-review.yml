name: Generate Song Review

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited]

jobs:
  generate-review:
    # Only run on PR comments or PRs with Spotify URLs
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, 'spotify.com/track/')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, 'spotify.com/track/'))

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Checkout the PR branch, not main
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || github.event.issue.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Generate Song Review
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: node scripts/generate-song-review.mjs

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet src/content/songs/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push review
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/content/songs/
          git commit -m "feat(music): add AI-generated song review"
          git push

      - name: Comment on PR
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('src/content/songs')
              .filter(f => f.endsWith('.md') && f !== '.gitkeep')
              .sort((a, b) => {
                const statA = fs.statSync(`src/content/songs/${a}`);
                const statB = fs.statSync(`src/content/songs/${b}`);
                return statB.mtime - statA.mtime;
              });

            const latestFile = files[0];
            const content = fs.readFileSync(`src/content/songs/${latestFile}`, 'utf8');
            const titleMatch = content.match(/title: "(.+)"/);
            const artistMatch = content.match(/artist: "(.+)"/);

            const title = titleMatch ? titleMatch[1] : 'Unknown Track';
            const artist = artistMatch ? artistMatch[1] : 'Unknown Artist';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üéµ **Song review generated!**\n\n**${title}** by **${artist}**\n\nReview file: \`src/content/songs/${latestFile}\`\n\n_Generated with AI using OpenAI GPT-4o-mini_`
            });

      - name: Comment if no changes
        if: steps.check_changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ÑπÔ∏è No new song reviews were generated. The track may already have a review, or no valid Spotify track URLs were found.`
            });
